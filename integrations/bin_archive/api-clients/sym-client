#!/data/data/com.termux/files/usr/bin/python

# sym-client — CLI para consumir la API de SymContext desde consola
import requests
import json
import argparse

# === Configuración ===
BASE_URL = "http://127.0.0.1:8000"  # O IP en red local
API_TOKEN = "sym-xxxxx"  # Mismo que en settings.json

HEADERS = {
    "Authorization": f"Bearer {API_TOKEN}",
    "Content-Type": "application/json"
}

# === Funciones ===

def registrar(texto):
    r = requests.post(f"{BASE_URL}/symctx/register", headers=HEADERS, json={"texto": texto})
    print(json.dumps(r.json(), indent=2, ensure_ascii=False))

def ver_config():
    r = requests.get(f"{BASE_URL}/symctx/config", headers=HEADERS)
    print(json.dumps(r.json(), indent=2, ensure_ascii=False))

def ver_entradas():
    r = requests.get(f"{BASE_URL}/symctx/view", headers=HEADERS)
    print(json.dumps(r.json(), indent=2, ensure_ascii=False))

def buscar_similares(texto, top_n=5):
    payload = {"texto": texto, "top_n": top_n}
    r = requests.post(f"{BASE_URL}/symctx/similares", headers=HEADERS, json=payload)
    print(json.dumps(r.json(), indent=2, ensure_ascii=False))

def narrativa():
    r = requests.post(f"{BASE_URL}/symctx/narrative", headers=HEADERS)
    print(json.dumps(r.json(), indent=2, ensure_ascii=False))

def transiciones():
    r = requests.post(f"{BASE_URL}/symctx/transitions", headers=HEADERS)
    print(json.dumps(r.json(), indent=2, ensure_ascii=False))

def timeline():
    r = requests.post(f"{BASE_URL}/symctx/transitions", headers=HEADERS)
    print(json.dumps(r.json(), indent=2, ensure_ascii=False))

def find_related(texto, top_n=5):
    payload = {"texto": texto} #, "top_n": top_n}
    r = requests.post(f"{BASE_URL}/symctx/find_related", headers=HEADERS, json=payload)
    print(json.dumps(r.json(), indent=2, ensure_ascii=False))


# === CLI Parser ===
def main():
    parser = argparse.ArgumentParser(prog="sym-client", description="Cliente para SymContext API")
    sub = parser.add_subparsers(dest="cmd")

    sub.add_parser("narrative", help="Análisis narrativo simbólico")
    sub.add_parser("transitions", help="Análisis de transiciones simbólicas")
    sub.add_parser("timeline", help="Análisis de linea de vida simbólica")
    sub.add_parser("view", help="Ver entradas")
    sub.add_parser("config", help="Ver configuración actual")

    reg = sub.add_parser("registrar", help="Registrar nueva entrada")
    reg.add_argument("texto")

    sim = sub.add_parser("similares", help="Buscar entradas similares")
    sim.add_argument("texto")
    sim.add_argument("--top", type=int, default=5)

    rel = sub.add_parser("find_related", help="Análisis simbólico de relacionados")
    rel.add_argument("texto")
    rel.add_argument("--top", type=int, default=5)

    args = parser.parse_args()

    if args.cmd == "registrar":
        registrar(args.texto)
    elif args.cmd == "similares":
        buscar_similares(args.texto, args.top)
    elif args.cmd == "find_related":
        find_related(args.texto, args.top)
    elif args.cmd == "narrative":
        narrativa()
    elif args.cmd == "transitions":
        transiciones()
    elif args.cmd == "view":
        ver_entradas()
    elif args.cmd == "config":
        ver_config()
    elif args.cmd == "timeline":
        timeline()
    else:
        parser.print_help()


if __name__ == "__main__":
    main()
